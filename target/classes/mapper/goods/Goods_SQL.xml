<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="goods">

	<select id="newGoodsList" parameterType="hashmap" resultType="hashmap"> <!-- 최근순 상품리스트 -->
		<![CDATA[
SELECT
				AAA.* 
			FROM( select count(*) over() as total_count, AA.*
			FROM(
				select ROW_NUMBER() OVER (ORDER BY GOODS_DATE desc) RNUM,
				gs.GOODS_NO,
				gs.GOODS_CATEGORY,
				gs.GOODS_NAME,
				gs.GOODS_CONTENT,
				gs.GOODS_ORIGIN_PRICE,
				gs.GOODS_SELL_PRICE,
				gs.GOODS_SALE_PRICE,
				gs.GOODS_DATE,
				gs.GOODS_KEYWORD,
				gs.GOODS_READCNT,
                gs.GOODS_PICK,
				up.UPLOAD_SAVE_NAME,
				att.GOODS_ATT_COLOR
			FROM
				goods gs ,upload up, goods_attribute att
				WHERE gs.GOODS_NO = up.GOODS_NO AND gs.GOODS_NO = att.GOODS_NO
                AND up.GOODS_NO = att.GOODS_NO
				) AA
		      ) AAA
		      WHERE AAA.RNUM BETWEEN 0 AND 12 
		]]>
	</select>
	
	<select id="bestGoodsList" parameterType="hashmap" resultType="hashmap"> <!-- best 상품리스트 -->
		<![CDATA[
			SELECT
			AAA.* 
			FROM( select count(*) over() as total_count, AA.*
			FROM(
				select ROW_NUMBER() OVER (ORDER BY GOODS_READCNT desc) RNUM,
				gs.GOODS_NO,
				gs.GOODS_CATEGORY,
				gs.GOODS_NAME,
				gs.GOODS_CONTENT,
				gs.GOODS_ORIGIN_PRICE,
				gs.GOODS_SELL_PRICE,
				gs.GOODS_SALE_PRICE,
				gs.GOODS_DATE,
				gs.GOODS_KEYWORD,
				gs.GOODS_READCNT,
				gs.GOODS_PICK,
				up.UPLOAD_SAVE_NAME,
				att.GOODS_ATT_COLOR
			FROM
				goods gs ,upload up, goods_attribute att
			WHERE gs.GOODS_NO = up.GOODS_NO AND gs.GOODS_NO = att.GOODS_NO
                AND up.GOODS_NO = att.GOODS_NO
			) AA
		      ) AAA
		      WHERE AAA.RNUM BETWEEN 0 AND 28
		       
		]]>
	</select>
	
	
	<select id="cateGoodsList" parameterType="hashmap" resultType="hashmap"> <!-- 카테고리별 순서출력 -->
		<![CDATA[
			SELECT AAA.* FROM(
				SELECT COUNT(*) OVER() AS TOTAL_COUNT, AA.* FROM(
					SELECT ROW_NUMBER() OVER (ORDER BY GS.GOODS_NO DESC) RNUM,
						gs.GOODS_NO,
						gs.GOODS_CATEGORY,
						gs.GOODS_NAME,
						gs.GOODS_CONTENT,
						gs.GOODS_ORIGIN_PRICE,
						gs.GOODS_SELL_PRICE,
						gs.GOODS_SALE_PRICE, 
						gs.GOODS_DATE,
						gs.GOODS_KEYWORD,
						gs.GOODS_READCNT, 
						gs.GOODS_PICK, 
						up.UPLOAD_SAVE_NAME,
						att.GOODS_ATT_COLOR
						FROM
							GOODS GS ,UPLOAD UP, GOODS_ATTRIBUTE ATT
								WHERE GS.GOODS_NO = UP.GOODS_NO AND GS.GOODS_NO = ATT.GOODS_NO
	               					  AND UP.GOODS_NO = ATT.GOODS_NO
	               					  AND GS.GOODS_CATEGORY = #{cate}
	               					  ) AA
	               					  	) AAA
	               					  		WHERE AAA.RNUM BETWEEN 0 AND 28
		]]>
		<if test="orderBy != '' and orderBy != 'null'">
			<![CDATA[
				ORDER BY AAA.${orderBy} ${orderSort} 
			]]>
		</if> 
	</select>
	
	
	
	<select id="goodsDetail" parameterType="hashmap" resultType="hashmap"> <!-- 상품상세보기 -->
		<![CDATA[
			SELECT 
				gs.GOODS_NO,
				gs.GOODS_CATEGORY,
				gs.GOODS_NAME,
				gs.GOODS_CONTENT,
				gs.GOODS_ORIGIN_PRICE,
				gs.GOODS_SELL_PRICE,
				gs.GOODS_SALE_PRICE, 
				gs.GOODS_DATE,
				gs.GOODS_KEYWORD,
				gs.GOODS_READCNT, 
				gs.GOODS_PICK,	
				att.GOODS_ATT_COLOR,
				att.GOODS_ATT_SIZE,
				att.GOODS_ATT_AMOUNT,
				up.REVIEW_NO,
				up.UPLOAD_SAVE_NAME
			FROM 
				GOODS GS ,UPLOAD UP, GOODS_ATTRIBUTE ATT
			WHERE GS.GOODS_NO = UP.GOODS_NO AND GS.GOODS_NO = ATT.GOODS_NO
	              AND UP.GOODS_NO = ATT.GOODS_NO
	           	  AND GS.GOODS_NO = #{IDX}	

		]]>
	</select>
	
	
	<update id="goodsReadCntUp" parameterType="hashmap">
		<![CDATA[
			UPDATE GOODS
			SET
				GOODS_READCNT = NVL(GOODS_READCNT, 0) + 1
			WHERE
				GOODS_NO = #{IDX}
		]]>
	</update>
	

	<insert id="goodsInsert" parameterType="hashmap" useGeneratedKeys="true" keyProperty="GOODS_NO">
		<selectKey keyProperty="GOODS_NO" resultType="string" order="BEFORE">
			SELECT GOODS_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		<![CDATA[
			INSERT INTO GOODS(
								GOODS_NO,
								GOODS_CATEGORY,
								GOODS_NAME,
								GOODS_CONTENT,
								GOODS_ORIGIN_PRICE,
								GOODS_SELL_PRICE,
								GOODS_SALE_PRICE,
								GOODS_DATE,
								GOODS_KEYWORD,
								GOODS_PICK
							 )
						VALUES(
								#{GOODS_NO},
								#{GOODS_CATEGORY},
								#{GOODS_NAME},
								#{GOODS_CONTENT},
								#{GOODS_ORIGIN_PRICE},
								#{GOODS_SELL_PRICE},
								#{GOODS_SALE_PRICE},
								sysdate,
								#{GOODS_KEYWORD},
								#{GOODS_PICK}
							  )				
		]]>
	</insert>

	<insert id="attributeInsert" parameterType="hashmap">
		<![CDATA[
			INSERT INTO GOODS_ATTRIBUTE(
										GOODS_ATT_NO,
										GOODS_NO,
										GOODS_ATT_SIZE,
										GOODS_ATT_COLOR,
										GOODS_ATT_AMOUNT
										)
								values(
										GOODS_ATT_NO_SEQ.NEXTVAL,
										#{GOODS_NO},
										#{GOODS_ATT_SIZE},
										#{GOODS_ATT_COLOR},
										#{GOODS_ATT_AMOUNT}
									    )
		
		]]>
	</insert>
	
	<insert id="insertFile" parameterType="hashmap">
		<![CDATA[
			INSERT INTO UPLOAD
			(
				UPLOAD_NO,
				GOODS_NO,
				UPLOAD_ORIGIN_NAME,
				UPLOAD_SAVE_NAME,
				UPLOAD_SIZE
			)
			VALUES
			(
				UPLOAD_NO_SEQ.NEXTVAL,
				#{GOODS_NO},
				#{UPLOAD_ORIGIN_NAME},
				#{UPLOAD_SAVE_NAME},
				#{UPLOAD_SIZE}
			)
		]]>
	</insert>
	
	<select id="selectFileList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
			    UPLOAD_NO,
			    UPLOAD_ORIGIN_NAME,
			    ROUND(UPLOAD_SIZE/1024,1) AS UPLOAD_SIZE
			FROM
			    UPLOAD
			WHERE
			    GOODS_NO = #{GOODS_NO}
			    AND UPLOAD_DELETE = '0'
		]]>
	</select>
	
	<update id="deleteFileList" parameterType="hashmap">
		<![CDATA[
			UPDATE UPLOAD
				UPLOAD_DELETE = '1' 
			WHERE 
				GOODS_NO = #{GOODS_NO}	
		]]>
	</update>
	
	<update id="updateFile" parameterType="hashmap">
		<![CDATA[
			UPDATE UPLOAD SET
				UPLOAD_DELETE = '0'
			WHERE
				UPLOAD_NO = #{FILE_IDX}	
		]]>
	</update>
	

</mapper>